<!doctype html>
<html>
<head>

	<!-- Meta Tag -->
	<meta charset="utf-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="description" content="virapay" />
	<meta name="keywords" content="virapay, vira, pay" />
	<meta id="theme-color" name="theme-color" content="#ffffff">
	<meta name="yandex-verification" content="0e027f9006505dab" />

	<!-- Webfonts -->
	<link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap" rel="stylesheet" crossorigin="anonymous">
	<link href="https://cdn.materialdesignicons.com/5.0.45/css/materialdesignicons.min.css" rel="stylesheet" crossorigin="anonymous"/>

	<!-- UI framework -->
	<link href="css/typography.css" rel="stylesheet"/>

<!--    <link href="/css/colors.css" rel="stylesheet"/>
    <link href="/css/reset.css" rel="stylesheet"/>
	<link href="/css/typography.css" rel="stylesheet"/>
	<link href="/css/group.css" rel="stylesheet"/>-->

	<!-- Common -->
	<link href="css/common.css" rel="stylesheet"/>

	<!-- Core code -->
	<!--<script src="js/debug/output.js" type="text/javascript" charset="utf-8"></script>-->
	<script src="js/storage.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/JSONRPC2.js" type="text/javascript" charset="utf-8"></script>

	<!-- Google Sign In -->
    <script src="https://apis.google.com/js/platform.js"></script>

	<!-- Facebook API -->
	<script src="https://connect.facebook.net/en_US/sdk.js"></script>

	<!-- VK API -->
	<script src="https://vk.com/js/api/openapi.js?168" type="text/javascript"></script>

<style>

/* custom */

/*
html {
	font-family: 'Roboto', sans-serif;
    font-size: 14px;
}

body {
	margin: 0;
	color: #000;
	background-color: #ffffff;
}
*/

h1, h2, h3, h4, h5, h6 {
	font-family: inherit;
}

/*code {
	font-family: 'Ubuntu Mono', monospace;
}*/

.icon {
	font-size: 1.25em;
	display: inline-flex;
    align-items: center;
}

/* custom activities */

.activity.loading > .container {
	padding-bottom: 4rem;
}

.activity > .container > i.display1 {
	color: gainsboro;
	line-height: 10rem;
    font-size: 10rem;
}

.activity.login > .container {
	display: flex;
	flex-flow: column;
	align-items: center;
	justify-content: center;
}

.activity.login .logo {
	margin-bottom: 2rem;
}

.activity.login p {
    width: 20rem;
    font-size: 0.8rem;
}

.activity.profile {
	padding-top: 4rem;
}

.activity.profile .container {
	width: 100%;
	max-width: 40rem;
	align-items: center;
}

.activity.profile .avatar {
	width: 10rem;
	height: 10rem;
	border-radius: 50%;
}

.activity.profile h2, .activity.profile small, .activity.profile .label, .activity.profile .button {
	margin-bottom: 2rem;
}

.activity.profile .avatar {
	margin-bottom: 1rem;
}

.activity.profile .info {
	max-width: 20em;
	border-top: 1px solid #eee;
	padding-top: 2rem;
}

.activity.profile .button.logout {
	margin-top: 2rem;
}

.activity.message button {
	margin-top: 1rem;
}

.activity.main > .container {
	align-items: center;
	width: 100%;
	max-width: 30rem;
}

.activity.main .hot-icons {
	width: 100%;
	height: 6rem;
	display: flex;
	flex-flow: row;
	justify-content: space-between;
	margin-top: 2rem;
	margin-bottom: 2rem;
}

.activity.main .hot-icons a {
	padding: 1rem;
	display: flex;
	flex-flow: column;
	align-items: center;
	cursor: pointer;
	width: calc((100% - 2rem) / 3);
	font-weight: bold;
}

.activity.main .hot-icons a .icon {
	font-size: 3rem;
}

.activity.main .hot-icons .open-favorites .icon {
	color: #fc0;
}

.activity.main .hot-icons .open-scanner .icon {
	color: #fd0000;
}

.activity.main .hot-icons .open-history .icon {
	color: #4a0;
}

.activity.main .categories {
	width: 100%;
	display: flex;
	flex-flow: row wrap;
	justify-content: space-between;
	margin-bottom: 2rem;
}

.activity.main .categories a {
	width: calc((100% - 2rem) / 3);
	padding: 1rem;
	margin-bottom: 1rem;
	box-sizing: border-box;
	display: flex;
	flex-flow: column;
	align-items: center;
	-border: 1px solid rgb(77, 144, 254);
	box-shadow: 0 0 1rem rgba(0,0,0,0.1);
	border-radius: 5px;
	height: 8rem;
	cursor: pointer;
}

.activity.main .categories a .icon {
	font-size: 2.5rem;
	color: rgb(77, 144, 254);
}

.activity.main .categories a span {
	text-align: center;
	display: block;
	font-size: 0.8rem;
}

.activity.main .categories a.selected {
	background: rgb(77, 144, 254);
}

.activity.main .categories a.selected > * {
	color: #fff;
}

.activity.main .partners > .provider {
	display: flex;
	flex-flow: row;
	justify-content: space-between;
}

.activity.main .partners > .provider .icon {
	width: 3rem;
	font-size: 1.5rem;
	justify-content: center;
}

.activity.main .partners {
	width: 100%;
}

.activity.main .partners > .provider {
	width: 100%;
	cursor: pointer;
	padding-top: 0.5rem;
	padding-bottom: 0.5rem;
	border-top: 1px solid #eee;
}

.activity.main .partners > .provider .details {
	width: calc(100% - 3rem * 2);
}

.activity.main .partners > .provider .name {
	font-weight: bold;
}

.activity.main .partners > .provider .service {
	opacity: 0.7;
	font-weight: 300;
}

.activity.main .profile-show {
	display: flex;
	align-items: center;
	cursor: pointer;
	border-radius: 2rem;
	box-shadow: 0 0 1rem rgba(0,0,0,0.1);
}

.activity.main .avatar {
	width: 2rem;
	height: 2rem;
	border-radius: 50%;
	margin-right: 0.5rem;
	margin-left: 0.1rem;
	margin-top: 0.1rem;
	margin-bottom: 0.1rem;
}

.activity.main .fullname {
	margin-right: 1rem;
}

.activity h5 {
	margin-top: 2rem;
	margin-bottom: 1rem;
}

/* media */

@media (max-width: 767px) {
}

@media (min-width: 768px) {
}



/* buttons */

/*.button-auth {
	display: flex;
	align-items: center;
	justify-content: center;
	padding-left: 1rem;
	padding-right: 1rem;
	height: 2.5rem;
	width: 100%;
	max-width: 20rem;
	box-sizing: border-box;
	margin-bottom: 1rem;
	border: 0;
	border-radius: 0.25rem;
	background: #fff;
	box-shadow: 0.05rem 0.15rem 0 rgba(0,0,0,0.2);
	cursor: pointer;
}

.button-auth > .icon {
	height: 1.5rem;
	font-size: 1.5rem;
	margin-right: 0.5rem;
}

.button-auth > span {
	display: block;
	width: 100%;
	text-align: center;
	text-transform: uppercase;
}*/

.signin-with-google {
	border: 1px solid rgba(0,0,0,0.1);
}

.signin-with-facebook {
	color: #fff;
	background: rgb(24, 119, 242);
}

.signin-with-vk {
	color: #fff;
	background: #4c75a3;
}

/* utilities */

.is-hidden {
	display: none;
}

/*.wide {
	width: 100%;
}*/

.spin {
	animation: spin 0.3s linear infinite;	
}

@keyframes spin {
	from {
		transform: rotate(0deg);
	}
	to {
		transform: rotate(360deg);
	}
}











/*
.debug-console {
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	height: 100vh;
    height: -webkit-fill-available;
	overflow: auto;
	z-index: 1000;
	box-sizing: border-box;
	padding: 1rem;
	font-size: 0.8rem;
}

.debug-console .output {
	margin: 0;
}
*/

</style>

</head>
<body>

<!--
	<div class="debug-console">
		<pre class="output"></pre>
	</div>
-->

	<div class="activity at-center loading">
		<div class="container">
			<i class="mdi mdi-loading display4 spin"></i>
		</div>
	</div>

	<div class="activity at-center message is-hidden">
		<div class="container">
			<h2 class="title"></h2>
			<p>
				<i class="icon mdi mdi-alert-outline"></i>
				<span class="text"></span>
			</p>
			<button class="button primary action">
	            <span>Продолжить</span>
				<i class="icon mdi mdi-arrow-right"></i>
			</button>
		</div>
	</div>

	<div class="activity profile is-hidden">

		<div class="action-bar">
			<div class="container">
				<a class="icon mdi mdi-chevron-left back"></a>
			</div>
		</div>

		<div class="container">

			<h2>Добро пожаловать!</h2>

			<img class="avatar"/>

			<small><span class="apiname"></span>/<span class="id"></span></small>

			<label class="label">
				<div>Полное Имя</div>
				<div><input class="fullname"/></div>
			</label>

			<label class="label">
				<div>Email</div>
				<div><input class="email"/></div>
			</label>

			<button class="button primary profile-save">
	            <span>Продолжить</span>
				<i class="icon mdi mdi-arrow-right"></i>
			</button>

			<p class="info">Вы можете выйти в любое время. Если возникла такая необходимость, нажмите кнопку <q>Выход</q>.</p>

			<button class="button light logout">Выход</div>

		</div>
	</div>

	<div class="activity at-center login is-hidden">

		<div class="container">

			<div class="logo vertical">
		        <img src="images/logo.svg"/>
		        <div><span>VIRA</span><span>PAY</span></div>
			</div>

			<button class="button -button-auth signin-with-google is-hidden">
	            <img class="icon" src="/images/google_g_logo.svg"/>
	            <span>Войти с Google</span>
			</button>

			<button class="button -button-auth signin-with-facebook is-hidden">
	            <!--<img class="icon" src="/images/facebook_f_logo.svg"/>-->
				<i class="icon mdi mdi-facebook"></i>
	            <span>Войти с Facebook</span>
			</button>

			<button class="button -button-auth signin-with-vk is-hidden">
	            <!--<img class="icon" src="/images/vk_logo.svg"/>-->
				<i class="icon mdi mdi-vk"></i>
	            <span>Войти с ВКонтакте</span>
			</button>

			<p>Нажимая кнопку, вы подтверждаете, что ознакомились с <a href="policy.html">политикой конфиденциальности</a>, даете согласие на обработку своих персональных данных и соглашаетесь с <a href="offer.html">условиями использования</a>.</p>

		</div>
	</div>

	<div class="activity main is-hidden">

		<div class="container">

			<div class="profile-show">
				<img class="avatar"/>
				<small class="fullname">VIRAPAY</small>
			</div>

			<div class="hot-icons">
				<a class="open-favorites">
					<i class="icon mdi mdi-star-outline"></i>
					<span>Избранное</span>
				</a>
				<a class="open-scanner">
					<i class="icon mdi mdi-qrcode-scan"></i>
					<span>Сканнер</span>
				</a>
				<a class="open-history">
					<i class="icon mdi mdi-history"></i>
					<span>История</span>
				</a>
			</div>

			<h5>Категории</h5>
			<div class="categories">
				<a class="category" data-id="1">
					<i class="icon mdi mdi-office-building"></i>
					<span>Коммунальные услуги</span>
				</a>
				<a class="category" data-id="2">
					<i class="icon mdi mdi-web"></i>
					<span>Интернет</span>
				</a>
				<a class="category" data-id="3">
					<i class="icon mdi mdi-television-classic"></i>
					<span>Телевидение</span>
				</a>
				<a class="category" data-id="4">
					<i class="icon mdi mdi-phone-in-talk"></i>
					<span>Телефон</span>
				</a>
				<a class="category" data-id="5">
					<i class="icon mdi mdi-gamepad-variant-outline"></i>
					<span>Игры</span>
				</a>
				<a class="category" data-id="6">
					<i class="icon mdi mdi-dots-horizontal"></i>
					<span>Прочее</span>
				</a>
			</div>

			<h5>Все услуги</h5>
			<div class="partners">

				<div class="provider">
					<a class="icon mdi mdi-star-outline"></a>
					<div class="details">
						<div class="name">Промсвязьмонтаж ООО</div>
						<div class="service">Домофон</div>
					</div>
					<a class="icon mdi mdi-chevron-right"></a>
				</div>

				<div class="provider">
					<a class="icon mdi mdi-star-outline"></a>
					<div class="details">
						<div class="name">Промсвязьмонтаж ООО</div>
						<div class="service">Пени</div>
					</div>
					<a class="icon mdi mdi-chevron-right"></a>
				</div>

				<div class="provider">
					<a class="icon mdi mdi-star-outline"></a>
					<div class="details">
						<div class="name">Газпром межрегионгаз Иваново ООО</div>
						<div class="service">Оплата за ВГДО</div>
					</div>
					<a class="icon mdi mdi-chevron-right"></a>
				</div>

			</div>


		</div>
	</div>

</body>
<script>

'use strict';

let isLoggedInWith = {
	google: undefined,
	facebook: undefined,
	vk: undefined
}

function isLoggedIn() {
	if (isLoggedInWith.google === undefined
	 || isLoggedInWith.facebook === undefined
	 || isLoggedInWith.vk === undefined) {
		return undefined
	}
	return isLoggedInWith.google || isLoggedInWith.facebook || isLoggedInWith.vk
}

function isLoggedOut() {
console.log('isLoggedOut()',isLoggedIn() === false)
	return isLoggedIn() === false
}

// activities

let activities = Array.from(document.querySelectorAll('.activity'))
let activityLoading = activities.reduce((_, a) => a.classList.contains('loading') ? a : _, null)
let activityMessage = activities.reduce((_, a) => a.classList.contains('message') ? a : _, null)
let activityLogin = activities.reduce((_, a) => a.classList.contains('login') ? a : _, null)
let activityProfile = activities.reduce((_, a) => a.classList.contains('profile') ? a : _, null)
let activityMain = activities.reduce((_, a) => a.classList.contains('main') ? a : _, null)

// activities switcher

function switchActivity(activity) {
	activities.forEach(a => a.classList.add('is-hidden'))
	activity.classList.remove('is-hidden')
}

// message

function showMessage(title, text, actionCallback) {
	activityMessage.querySelector('.title').innerText = title
	activityMessage.querySelector('.text').innerText = text
	activityMessage.querySelectorAll('.action').forEach(node => {
		node.onclick = function () {
			actionCallback();
		}
	})
	switchActivity(activityMessage)
}

// backend node

let backend = new JSONRPC2.RemoteProxyObject(
	// using JSON RPC over HTTP
	new JSONRPC2.Transports.HTTP(
		'https://powerful-taiga-14558.herokuapp.com/rpc/json',
		 {
			mode: 'cors'
		 }
	)
)

// profile functions

async function profileInit(apiName, id, fullName, imageUrl, email, token, logoutCallback) {

	switchActivity(activityLoading)

	try {

		console.log('LOGIN REQUEST', apiName, id, token)

		let result = await backend.login(apiName, id, token, name, email)

		console.log('LOGIN RESULT', result)

		if (result) {

			activityProfile.querySelector('.avatar').src = imageUrl
			activityProfile.querySelector('.apiname').innerText = apiName
			activityProfile.querySelector('.id').innerText = id
			activityProfile.querySelector('.fullname').value = result.name
			activityProfile.querySelector('.email').value = result.email
			activityProfile.querySelectorAll('.logout').forEach(node => {
				node.onclick = function () {
					logoutCallback();
				}
			})
			activityProfile.querySelectorAll('.back').forEach(node => {
				if (result.isNew) {
					node.onclick = function () {
						logoutCallback()
					}
				} else {
					node.onclick = function () {
						switchActivity(activityMain)
					}
				}
			})
			activityProfile.querySelectorAll('.profile-save').forEach(node => {
				node.onclick = async function () {
					switchActivity(activityLoading)
					try {
						let name = activityProfile.querySelector('.fullname').value
						let email = activityProfile.querySelector('.email').value
						let result = await backend.profileUpdate(
							apiName, id, token,
							name, email
						)
						console.log('SAVING PROFILE RESULT', result)
						if (result) {
							activityMain.querySelector('.fullname').innerText = name
							activityProfile.querySelectorAll('.back').forEach(node => {
								node.onclick = function () {
									switchActivity(activityMain)
								}
							})
							switchActivity(activityMain)
						} else {
							showMessage('Профиль пользователя', 'Не удалось сохранить данные. Попробуйте позднее.', () => switchActivity(activityProfile))
						}
					} catch (errorProfileSaving) {
						console.log('SAVING PROFILE FAILED', errorProfileSaving)
						showMessage('Профиль пользователя', 'Не удалось сохранить данные. Попробуйте позднее.', () => switchActivity(activityProfile))
					}
				}
			})
			activityMain.querySelector('.avatar').src = imageUrl
			activityMain.querySelector('.fullname').innerText = result.name
			activityMain.querySelectorAll('.profile-show').forEach(node => {
				node.onclick = function () {
					switchActivity(activityProfile)
				}
			})

			if (result.isNew) {
				switchActivity(activityProfile)
			} else {
				switchActivity(activityMain)
			}

		} else {

			showMessage('Вход', 'Не удалось подтвердить токен пользователя. Попробуйте позднее.', logoutCallback)
		}

	} catch (errorLogin) {

		console.log('LOGIN FAILED', errorLogin)
		showMessage('Вход', 'Не удалось выпольнить вход в приложение. Попробуйте позднее.', logoutCallback)
	}

}

// main

(function () {

	let categories = activityMain.querySelectorAll('.category')

	categories.forEach(category => {
		category.onclick = () => {
			category.classList.toggle('selected')
		}
	})

})();


</script>

	<!-- Auth -->
	<script src="js/login/google.js" type="text/javascript" charset="utf-8" async="true" defer="true"></script>
	<script src="js/login/facebook.js" type="text/javascript" charset="utf-8" async="true" defer="true"></script>
	<script src="js/login/vk.js" type="text/javascript" charset="utf-8" async="true" defer="true"></script>

	<!-- DEBUG -->
	<link href="css/debug/grid.css" rel="stylesheet"/>
	<script src="js/debug/grid.js" type="text/javascript" charset="utf-8"></script>

</html>